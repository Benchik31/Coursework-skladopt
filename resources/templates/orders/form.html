<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head(~{::title})}">
    <title th:text="${pageTitle}">Новый заказ</title>
</head>
<body>
<div th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}">
    <main>
        <div th:replace="~{fragments/breadcrumbs :: breadcrumbs(pageTitle)}"></div>
        <h1 class="h4 mb-3" th:text="${pageTitle}">Новый заказ</h1>

        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <form th:action="@{/orders}" th:object="${form}" method="post" class="row g-3">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="col-md-6">
                <label class="form-label" for="customer">Клиент</label>
                <select id="customer" class="form-select" th:field="*{customerId}" required>
                    <option th:value="${null}">Выберите клиента</option>
                    <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.name}">Клиент</option>
                </select>
                <div class="text-danger small" th:if="${#fields.hasErrors('customerId')}" th:errors="*{customerId}">Ошибка</div>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="comment">Комментарий</label>
                <input id="comment" type="text" class="form-control" th:field="*{comment}" placeholder="Опционально">
            </div>

            <div class="col-12">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="width: 45%;">Товар</th>
                            <th style="width: 20%;" class="text-end">Кол-во</th>
                            <th style="width: 20%;" class="text-end">Цена</th>
                            <th class="text-end">Сумма</th>
                        </tr>
                        </thead>
                        <tbody id="linesBody" th:data-count="${#lists.size(form.lines)}">
                        <tr th:each="line,idx : *{lines}" class="line-row">
                            <td>
                                <select class="form-select" th:field="*{lines[__${idx.index}__].productId}">
                                    <option th:value="${null}">— выберите товар —</option>
                                    <option th:each="p : ${products}" th:value="${p.id}"
                                            th:text="${p.name + ' (' + p.sku + ')'}">Товар</option>
                                </select>
                            </td>
                            <td class="text-end">
                                <input type="number" min="1" step="1" class="form-control text-end"
                                       th:field="*{lines[__${idx.index}__].quantity}" placeholder="0">
                            </td>
                            <td class="text-end">
                                <input type="number" min="0" step="0.01" class="form-control text-end"
                                       th:field="*{lines[__${idx.index}__].price}" placeholder="авто">
                            </td>
                            <td class="text-end text-muted small"
                                th:text="${line.price != null and line.quantity != null ? line.price.multiply(line.quantity) : '—'}">—</td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">Оставьте пустые строки, если они не нужны — они будут проигнорированы.</div>
                        <button class="btn btn-outline-secondary btn-sm" id="addLineBtn" type="button">+ Добавить строку</button>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <button class="btn btn-primary" type="submit">Создать</button>
                <a class="btn btn-outline-secondary" th:href="@{/orders}">Отмена</a>
            </div>
        </form>

        <template id="line-row-template">
            <tr class="line-row">
                <td>
                    <select class="form-select" name="lines[__idx__].productId">
                        <option value="">— выберите товар —</option>
                        <option th:each="p : ${products}" th:value="${p.id}"
                                th:text="${p.name + ' (' + p.sku + ')'}">Товар</option>
                    </select>
                </td>
                <td class="text-end">
                    <input type="number" min="1" step="1" class="form-control text-end"
                           name="lines[__idx__].quantity" placeholder="0">
                </td>
                <td class="text-end">
                    <input type="number" min="0" step="0.01" class="form-control text-end"
                           name="lines[__idx__].price" placeholder="авто">
                </td>
                <td class="text-end text-muted small">—</td>
            </tr>
        </template>

        <script th:inline="javascript">
            const body = document.getElementById('linesBody');
            const addBtn = document.getElementById('addLineBtn');
            const template = document.getElementById('line-row-template');
            let idx = parseInt(body?.dataset.count || body?.querySelectorAll('.line-row').length || 0, 10);

            addBtn?.addEventListener('click', () => {
                const clone = template.content.firstElementChild.cloneNode(true);
                const currentIdx = idx++;
                clone.querySelectorAll('[name]').forEach(el => {
                    el.name = el.name.replace('__idx__', currentIdx);
                    if (el.type !== 'hidden') {
                        el.value = '';
                    }
                });
                body.appendChild(clone);
                body.dataset.count = idx;
            });
        </script>
    </main>
</div>
</body>
</html>
