<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head(~{::title})}">
    <title th:text="${product.name}">Товар</title>
</head>
<body>
<div th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}">
    <main>
        <div th:replace="~{fragments/breadcrumbs :: breadcrumbs('Товар ' + product.sku)}"></div>
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
                <h1 class="h4 mb-1" th:text="${product.name}">Товар</h1>
                <p class="text-muted mb-0" th:text="${product.sku}">SKU</p>
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary" th:href="@{/products}">Назад к каталогу</a>
                <a class="btn btn-primary" th:href="@{'/products/' + ${product.id} + '/edit'}" sec:authorize="hasRole('ROLE_ADMIN')">Редактировать</a>
                <form th:action="@{'/products/' + ${product.id} + '/delete'}" method="post" sec:authorize="hasRole('ROLE_ADMIN')"
                      onsubmit="return confirm('Удалить товар? Это уберёт связанные остатки и строки заказов.');">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button class="btn btn-outline-danger" type="submit">Удалить</button>
                </form>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-5">
                <div class="ratio ratio-4x3 border rounded bg-light">
                    <img th:src="${product.imageUrl != null ? product.imageUrl : '/images/placeholder-product.svg'}"
                         class="object-fit-cover rounded" alt="Изображение">
                </div>
            </div>
            <div class="col-md-7">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="text-muted small">Категория</div>
                                <div th:text="${product.category != null ? product.category.name : '-'}">Категория</div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-muted small">Статус</div>
                                <span th:text="${product.active} ? 'Активен' : 'Неактивен'"
                                      th:classappend="${product.active} ? 'badge text-bg-success' : 'badge text-bg-secondary'">Активен</span>
                            </div>
                            <div class="col-md-6">
                                <div class="text-muted small">Цена</div>
                                <div th:text="${product.price}">0</div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-muted small">Мин. остаток</div>
                                <div th:text="${product.minStock}">0</div>
                            </div>
                            <div class="col-12" th:if="${product.description}">
                                <div class="text-muted small">Описание</div>
                                <div th:text="${product.description}">Описание</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h5 class="mb-2">Остатки по складам</h5>
        <div class="table-responsive mb-4">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th>Склад</th>
                    <th class="text-end">Доступно</th>
                    <th class="text-end">Резерв</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="st : ${stocks}">
                    <td th:text="${st.warehouse.name}">Склад</td>
                    <td class="text-end" th:text="${st.available}">0</td>
                    <td class="text-end" th:text="${st.reservedQty}">0</td>
                </tr>
                <tr th:if="${#lists.isEmpty(stocks)}">
                    <td colspan="3" class="text-center text-muted py-3">Остатков нет.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <h5 class="mb-2">Движения</h5>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th>Дата/время</th>
                    <th>Тип</th>
                    <th>Склад</th>
                    <th class="text-end">Кол-во</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="mv : ${movements}">
                    <td th:text="${#temporals.format(mv.movementTime, 'dd.MM.yyyy HH:mm')}">01.01.2025</td>
                    <td>
                        <span class="badge text-bg-success" th:if="${mv.type.name() == 'IN'}">IN</span>
                        <span class="badge text-bg-danger" th:if="${mv.type.name() == 'OUT'}">OUT</span>
                        <span class="badge text-bg-warning text-dark" th:if="${mv.type.name() == 'TRANSFER'}">TRANSFER</span>
                    </td>
                    <td>
                        <div th:text="${mv.warehouse != null ? mv.warehouse.name : '-'}">Склад</div>
                        <div class="text-muted small" th:if="${mv.targetWarehouse != null}"
                             th:text="'→ ' + ${mv.targetWarehouse.name}">→ Склад</div>
                    </td>
                    <td class="text-end" th:text="${mv.quantity}">0</td>
                </tr>
                <tr th:if="${#lists.isEmpty(movements)}">
                    <td colspan="4" class="text-center text-muted py-3">Движений нет.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>
</body>
</html>
